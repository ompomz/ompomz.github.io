<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>ompomznote</title>  
 <link rel="stylesheet" href="./note.css">
 <script src="https://ompomz.github.io/header/loadHeader.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
 <div id="header-placeholder"></div>
 <div class="note-container" id="content"></div>
<script>
const params = new URLSearchParams(window.location.search);
const id = params.get("id");
const content = document.getElementById("content");

function goBackOrHome(event){
    if (event) event.preventDefault();

    const ref = document.referrer;
    const isSameOrigin = ref && ref.startsWith(location.origin);

    // 新しいタブor直打ち用
    const isNoteToNewTab =
        !ref &&
        window.history.length === 1 &&
        location.search.includes("id=");

    // A. note.html → 詳細
    if (isSameOrigin && ref.includes("note.html")) {
        location.href = "./note.html";
        return;
    }

    // B. note.html の新しいタブ or 直打ち
    if (isNoteToNewTab) {
        location.href = "./note.html";
        return;
    }

    // C. 外部サイト → 詳細ページ（戻る）
    if (ref && !isSameOrigin) {
        history.back();
        return;
    }

    // D. 履歴あり → 普通に戻る
    if (window.history.length > 1) {
        history.back();
        return;
    }

    // E. URL直打ちなど
    location.href = "./note.html";
}

if (id) {
    fetch(`note/${id}.md`)
        .then(res => res.text())
        .then(md => {
            const renderer = new marked.Renderer();
            renderer.br = () => '</p><p>';
            const articleHtml = marked.parse(md, { renderer });

            const backLink = '<p><a href="./note.html" onclick="goBackOrHome(event);">＜ もどる</a></p>';
            content.innerHTML = articleHtml + '<hr>' + backLink;
        })
        .catch(() => {
            content.innerHTML = "<p>記事が見つかりません。</p>";
            const backLink = '<p><a href="./note.html" onclick="goBackOrHome(event);">＜ もどる</a></p>';
            content.innerHTML += backLink;
        });
} else {
    content.innerHTML = `
        <h2>ompomznote</h2>
        <ul>
            <li><a href="?id=251126">Memories of Nostrasia2025</a></li>
            <li><a href="?id=251201">test</a></li>
            <li><a href="?id=251204">Creating Client with AI</a></li>
        </ul>
    `;
}
</script>
</body>
</html>