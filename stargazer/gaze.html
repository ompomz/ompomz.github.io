<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr ãƒ•ã‚©ãƒ­ãƒ¼ã‚»ãƒƒãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åè¡¨ç¤ºï¼‰</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        h1 {
            color: #2c3e50;
        }
        #controls {
            margin-bottom: 20px;
        }
        #event-select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }
        #profiles-container {
            list-style: none;
            padding: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .profile-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: move;
            transition: background-color 0.2s;
        }
        .profile-item:last-child {
            border-bottom: none;
        }
        .profile-item:hover {
            background-color: #f9f9f9;
        }
        .profile-info {
            display: flex;
            flex-direction: column;
            margin-left: 10px;
        }
        .profile-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .profile-pubkey {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
            word-break: break-all;
        }
        .drag-handle {
            cursor: grab;
            margin-right: 10px;
            font-size: 1.2em;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
            margin-right: 10px; /* ãƒœã‚¿ãƒ³é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ  */
        }
        #load-button {
            background-color: #3498db;
            color: white;
        }
        #load-button:hover {
            background-color: #2980b9;
        }
        #load-private-button { /* æ–°ã—ã„ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #e67e22;
            color: white;
        }
        #load-private-button:hover {
            background-color: #d35400;
        }
        #save-button {
            background-color: #2ecc71;
            color: white;
        }
        #save-button:hover {
            background-color: #27ae60;
        }
        .hidden {
            display: none;
        }
        .info-text {
            color: #888;
            margin-top: 20px;
        }
        .sortable-ghost {
            opacity: 0.5;
            background-color: #e0f7fa;
        }
        .event-info {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>Nostr ãƒ•ã‚©ãƒ­ãƒ¼ã‚»ãƒƒãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</h1>

    <div id="controls">
        <button id="load-button">ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
        <button id="load-private-button">éå…¬é–‹ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
        <div id="event-selector-container" class="hidden">
            <p>ç·¨é›†ã™ã‚‹ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
            <select id="event-select"></select>
            <p class="event-info"></p>
        </div>
        <button id="save-button" class="hidden">å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹</button>
        <p class="info-text">â€» NIP-07å¯¾å¿œã®æ‹¡å¼µæ©Ÿèƒ½ã¨ `wss://relay.nostr.band` ã¸ã®æ¥ç¶šãŒå¿…è¦ã§ã™ã€‚</p>
    </div>

    <ul id="profiles-container">
        </ul>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const profilesContainer = document.getElementById('profiles-container');
            const loadButton = document.getElementById('load-button');
            const loadPrivateButton = document.getElementById('load-private-button');
            const saveButton = document.getElementById('save-button');
            const eventSelect = document.getElementById('event-select');
            const eventSelectorContainer = document.getElementById('event-selector-container');
            const eventInfo = document.querySelector('.event-info');

            const RELAY_URL = 'wss://relay.nostr.band';
            let allEvents = [];
            let currentEvent = null;
            let isPrivateList = false; // éå…¬é–‹ãƒªã‚¹ãƒˆã‹ã©ã†ã‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°
            let profileCache = {}; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

            // Sortable.js ã‚’åˆæœŸåŒ–
            new Sortable(profilesContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost'
            });

            // ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿å‡¦ç† (kind:30000, å…¬é–‹ãƒªã‚¹ãƒˆ)
            loadButton.addEventListener('click', async () => {
                if (!window.nostr) {
                    alert('NIP-07å¯¾å¿œã®æ‹¡å¼µæ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                await loadEvents([30000], false);
            });
            
            // éå…¬é–‹ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿å‡¦ç† (kind:10000, æš—å·åŒ–ãƒªã‚¹ãƒˆ)
            loadPrivateButton.addEventListener('click', async () => {
                if (!window.nostr || !window.nostr.nip04) {
                    alert('NIP-07ãŠã‚ˆã³NIP-04ã«å¯¾å¿œã—ãŸæ‹¡å¼µæ©Ÿèƒ½ãŒå¿…è¦ã§ã™ã€‚');
                    return;
                }
                await loadEvents([10000], true);
            });

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã‚€å…±é€šé–¢æ•°
            async function loadEvents(kinds, isPrivate) {
                allEvents = [];
                profilesContainer.innerHTML = '';
                eventSelectorContainer.classList.add('hidden');
                saveButton.classList.add('hidden');
                isPrivateList = isPrivate;

                const pubkey = await window.nostr.getPublicKey();
                const ws = new WebSocket(RELAY_URL);

                ws.onopen = () => {
                    const filter = {
                        kinds: kinds,
                        authors: [pubkey]
                    };
                    ws.send(JSON.stringify(["REQ", "my-follow-set-req", filter]));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data[0] === "EVENT") {
                        const nostrEvent = data[2];
                        allEvents.push(nostrEvent);
                    } else if (data[0] === "EOSE") {
                        ws.close();
                        if (allEvents.length === 0) {
                            alert(isPrivateList ? 'kind:10000ã®éå…¬é–‹ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚' : 'kind:30000ã®ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                            return;
                        }
                        
                        renderEventSelector(allEvents);
                        eventSelectorContainer.classList.remove('hidden');
                        saveButton.classList.remove('hidden');
                    }
                };
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆé¸æŠè‚¢ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
            function renderEventSelector(events) {
                eventSelect.innerHTML = '';
                events.forEach(event => {
                    const option = document.createElement('option');
                    const dTag = event.tags.find(tag => tag[0] === 'd');
                    const titleTag = event.tags.find(tag => tag[0] === 'title');
                    const eventTitle = titleTag ? titleTag[1] : (dTag ? dTag[1] : `ID: ${event.id.slice(0, 8)}...`);
                    
                    option.textContent = `${isPrivateList ? 'ğŸ”’' : ''} ${eventTitle}`;
                    option.value = event.id;
                    eventSelect.appendChild(option);
                });
                
                eventSelect.dispatchEvent(new Event('change'));
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
            eventSelect.addEventListener('change', async () => {
                const selectedId = eventSelect.value;
                currentEvent = allEvents.find(event => event.id === selectedId);

                if (currentEvent) {
                    profilesContainer.innerHTML = '<li>èª­ã¿è¾¼ã¿ä¸­...</li>';

                    let pubkeys = [];
                    // éå…¬é–‹ãƒªã‚¹ãƒˆã®å ´åˆã¯å¾©å·
                    if (isPrivateList) {
                        try {
                            const decryptedContent = await window.nostr.nip04.decrypt(currentEvent.pubkey, currentEvent.content);
                            const decryptedEvent = JSON.parse(decryptedContent);
                            pubkeys = decryptedEvent.p;
                        } catch (e) {
                            alert('éå…¬é–‹ãƒªã‚¹ãƒˆã®å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                            profilesContainer.innerHTML = '<li>å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</li>';
                            console.error('Decryption failed:', e);
                            return;
                        }
                    } else {
                        // å…¬é–‹ãƒªã‚¹ãƒˆã®å ´åˆã¯ã‚¿ã‚°ã‹ã‚‰æŠ½å‡º
                        pubkeys = currentEvent.tags.filter(tag => tag[0] === 'p').map(tag => tag[1]);
                    }
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—
                    await fetchProfiles(pubkeys);
                    
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    renderProfiles(pubkeys);
                    
                    const dTag = currentEvent.tags.find(tag => tag[0] === 'd');
                    const titleTag = currentEvent.tags.find(tag => tag[0] === 'title');
                    eventInfo.textContent = `d-tag: ${dTag ? dTag[1] : 'ãªã—'} / title-tag: ${titleTag ? titleTag[1] : 'ãªã—'}`;
                }
            });

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            async function fetchProfiles(pubkeys) {
                const missingPubkeys = pubkeys.filter(pubkey => !profileCache[pubkey]);

                if (missingPubkeys.length === 0) return;

                return new Promise((resolve) => {
                    const ws = new WebSocket(RELAY_URL);
                    ws.onopen = () => {
                        const filter = {
                            kinds: [0],
                            authors: missingPubkeys
                        };
                        ws.send(JSON.stringify(["REQ", "profile-req", filter]));
                    };
                    
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data[0] === "EVENT") {
                            const profileEvent = data[2];
                            try {
                                const profileData = JSON.parse(profileEvent.content);
                                profileCache[profileEvent.pubkey] = profileData;
                            } catch (e) {
                                console.error("Failed to parse profile content", e);
                            }
                        } else if (data[0] === "EOSE") {
                            ws.close();
                            resolve();
                        }
                    };
                });
            }

            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
            function renderProfiles(pubkeys) {
                profilesContainer.innerHTML = '';
                pubkeys.forEach(pubkey => {
                    const li = document.createElement('li');
                    li.className = 'profile-item';
                    li.dataset.pubkey = pubkey;

                    const name = profileCache[pubkey] ? profileCache[pubkey].name : null;
                    const displayName = name || `(åç„¡ã—)`;

                    li.innerHTML = `
                        <span class="drag-handle">â˜°</span>
                        <div class="profile-info">
                            <span class="profile-name">${displayName}</span>
                            <span class="profile-pubkey">${pubkey.slice(0, 8)}...${pubkey.slice(-8)}</span>
                        </div>
                    `;
                    profilesContainer.appendChild(li);
                });
            }

            // å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹å‡¦ç†
            saveButton.addEventListener('click', async () => {
                if (!currentEvent) {
                    alert('å…ˆã«ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
                    return;
                }

                const updatedPubkeys = Array.from(profilesContainer.children).map(li => li.dataset.pubkey);
                
                let newEvent;
                const newTags = currentEvent.tags.filter(tag => tag[0] !== 'p' && tag[0] !== 'e' && tag[0] !== 'd');
                
                if (isPrivateList) {
                    // éå…¬é–‹ãƒªã‚¹ãƒˆã®å ´åˆã¯ã€å…¬é–‹éµãƒªã‚¹ãƒˆã‚’JSONå½¢å¼ã§æš—å·åŒ–
                    const encryptedContent = await window.nostr.nip04.encrypt(currentEvent.pubkey, JSON.stringify({ p: updatedPubkeys }));
                    newEvent = {
                        kind: 10000,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: newTags,
                        content: encryptedContent
                    };
                } else {
                    // å…¬é–‹ãƒªã‚¹ãƒˆã®å ´åˆã¯ã€å…¬é–‹éµãƒªã‚¹ãƒˆã‚’pã‚¿ã‚°ã«è¿½åŠ 
                    const pTags = updatedPubkeys.map(pubkey => ["p", pubkey]);
                    newEvent = {
                        kind: 30000,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: newTags.concat(pTags),
                        content: ""
                    };
                }
                
                // å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆã®dã‚¿ã‚°ã‚’ç¶™æ‰¿
                const dTag = currentEvent.tags.find(tag => tag[0] === 'd');
                if (dTag) {
                    newEvent.tags.push(dTag);
                }

                try {
                    const signedEvent = await window.nostr.signEvent(newEvent);
                    const ws = new WebSocket(RELAY_URL);
                    ws.onopen = () => {
                        ws.send(JSON.stringify(["EVENT", signedEvent]));
                        console.log('ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¾ã—ãŸ:', signedEvent);
                        alert('ãƒ•ã‚©ãƒ­ãƒ¼ãƒªã‚¹ãƒˆãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
                        ws.close();
                    };
                } catch (error) {
                    console.error('ç½²åã¾ãŸã¯å…¬é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            });
        });
    </script>
</body>
</html>
