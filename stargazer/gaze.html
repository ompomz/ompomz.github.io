<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr フォローセットエディター</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }
        h1 {
            color: #2c3e50;
        }
        #controls {
            margin-bottom: 20px;
        }
        #profiles-container {
            list-style: none;
            padding: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .profile-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: move;
            transition: background-color 0.2s;
        }
        .profile-item:last-child {
            border-bottom: none;
        }
        .profile-item:hover {
            background-color: #f9f9f9;
        }
        .profile-pubkey {
            margin-left: 10px;
            font-family: monospace;
            word-break: break-all;
        }
        .drag-handle {
            cursor: grab;
            margin-right: 10px;
            font-size: 1.2em;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #load-button {
            background-color: #3498db;
            color: white;
        }
        #load-button:hover {
            background-color: #2980b9;
        }
        #save-button {
            background-color: #2ecc71;
            color: white;
        }
        #save-button:hover {
            background-color: #27ae60;
        }
        .hidden {
            display: none;
        }
        .info-text {
            color: #888;
            margin-top: 20px;
        }
        .sortable-ghost {
            opacity: 0.5;
            background-color: #e0f7fa;
        }
    </style>
</head>
<body>

    <h1>Nostr フォローセットエディター</h1>

    <div id="controls">
        <button id="load-button">フォローリストを読み込む</button>
        <button id="save-button" class="hidden">変更を保存する</button>
        <p class="info-text">※ NIP-07対応の拡張機能（nos2xなど）が必要です。</p>
    </div>

    <ul id="profiles-container">
        </ul>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const profilesContainer = document.getElementById('profiles-container');
            const loadButton = document.getElementById('load-button');
            const saveButton = document.getElementById('save-button');
            let originalEvent = null; // 読み込んだ元のイベントを保持

            // Sortable.js を初期化
            new Sortable(profilesContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost'
            });

            // フォローリストの読み込み処理
            loadButton.addEventListener('click', async () => {
                if (!window.nostr) {
                    alert('NIP-07対応の拡張機能が見つかりません。');
                    return;
                }

                const pubkey = await window.nostr.getPublicKey();
                const relay = 'wss://yabu.me'; // 読み込みたいリレーを指定

                const ws = new WebSocket(relay);
                ws.onopen = () => {
                    const filter = {
                        kinds: [30000],
                        authors: [pubkey]
                    };
                    ws.send(JSON.stringify(["REQ", "my-follow-set", filter]));
                };

                ws.onmessage = async (event) => {
                    const data = JSON.parse(event.data);
                    if (data[0] === "EVENT" && data[1] === "my-follow-set") {
                        const nostrEvent = data[2];
                        originalEvent = nostrEvent;

                        try {
                            const decryptedContent = await window.nostr.nip04.decrypt(pubkey, nostrEvent.content);
                            const followList = JSON.parse(decryptedContent);
                            renderProfiles(followList);
                            saveButton.classList.remove('hidden');
                        } catch (error) {
                            console.error('復号に失敗しました:', error);
                            alert('復号に失敗しました。このリストはあなたのものではないかもしれません。');
                        } finally {
                            ws.close();
                        }
                    }
                };
            });

            // プロフィールをレンダリングする関数
            function renderProfiles(pubkeys) {
                profilesContainer.innerHTML = '';
                pubkeys.forEach(pubkey => {
                    const li = document.createElement('li');
                    li.className = 'profile-item';
                    li.dataset.pubkey = pubkey;
                    li.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="profile-pubkey">${pubkey}</span>
                    `;
                    profilesContainer.appendChild(li);
                });
            }

            // 変更を保存する処理
            saveButton.addEventListener('click', async () => {
                if (!originalEvent) {
                    alert('先にフォローリストを読み込んでください。');
                    return;
                }

                // 順番が変わった後のpubkeyリストを取得
                const updatedPubkeys = Array.from(profilesContainer.children).map(li => li.dataset.pubkey);
                const updatedContent = JSON.stringify(updatedPubkeys);

                // NIP-04で新しいコンテンツを暗号化
                const myPubkey = await window.nostr.getPublicKey();
                const encryptedContent = await window.nostr.nip04.encrypt(myPubkey, updatedContent);

                const newEvent = {
                    kind: 30000,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: originalEvent.tags, // 元のタグを保持
                    content: encryptedContent,
                };

                try {
                    // NIP-07で署名して公開
                    const signedEvent = await window.nostr.signEvent(newEvent);
                    const relay = 'wss://yabu.me'; // 書き込みたいリレーを指定
                    const ws = new WebSocket(relay);
                    ws.onopen = () => {
                        ws.send(JSON.stringify(["EVENT", signedEvent]));
                        console.log('イベントを公開しました:', signedEvent);
                        alert('フォローリストが保存されました！');
                        ws.close();
                    };
                } catch (error) {
                    console.error('署名または公開に失敗しました:', error);
                    alert('保存に失敗しました。');
                }
            });
        });
    </script>
</body>
</html>
