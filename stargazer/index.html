<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>stargazer</title>
  <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
  <script>
    String.prototype.padStart = String.prototype.padStart ? String.prototype.padStart : function(targetLength, padString) {
      targetLength = Math.floor(targetLength) || 0;
      if(targetLength < this.length) return String(this);
    
      padString = padString ? String(padString) : " ";
    
      var pad = "";
      var len = targetLength - this.length;
      var i = 0;
      while(pad.length < len) {
        if(!padString[i]) {
          i = 0;
        }
        pad += padString[i];
        i++;
      }
      return pad + String(this).slice(0);
    };
    
    function getLanguage() {
      return (window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage).substring(0, 2);
    }
  </script>
  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";
  padding: 16px;
  line-height: 1.3;
  font-weight: normal;
  background-color: #f7f7f7;
  color: #333;
}
h4 {
  font-size: 1.25rem;
  color: #555;
  margin-bottom: .5rem;
}
p {
  font-size: .9rem;
  color: #666;
  margin-bottom: .25rem;
}
a {
  color: #007bff;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
.container {
  max-width: 600px;
  margin-left: .5rem;
  margin-right: auto;
  padding: .5rem;
}
@media (max-width: 767px) {
  .container {
    max-width: 100%;
    padding: 8px;
    margin: 0;
  }
}
label {
  font-size: .9rem;
  color: #666;
}
input[type="text"],
textarea {
  border: 1px solid #ccc;
  padding: 6px;
  border-radius: 4px;
  margin: 4px;
}
button {
  border: none;
  padding: 6px 12px;
  border-radius: 20px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  transition: background-color .2s;
  background-color: #aaa; /* „Éá„Éï„Ç©„É´„Éà„ÅÆ„Éú„Çø„É≥Ëâ≤ */
}
#apply-pubkey-for-reactions {
  background-color: #ff99cc;
}
#apply-pubkey-for-reactions:hover {
  background-color: #ff66b2;
}
button#load-more {
  background-color: #66b3ff;
}
button#load-more:hover {
  background-color: #4da6ff;
}
button#load-more.loading {
  visibility: hidden;
}
hr {
  border: none;
  border-top: 0px solid #ccc;
  margin: 0px 0px 0px 0px;
}
ul#timeline {
  list-style: none;
  padding: 0;
  margin: 8px 0;
  border-top: 1px solid #eee;
}
#timeline li {
  list-style: none !important;
}
li.event {
  word-break: break-all;
  padding: 6px 0;
  border-bottom: 1px solid #eee;
}
li.event-reaction {
  background-color: #f7f7f7;
}
.original-post-preview {
  margin: 0.5rem 0.5rem 0rem 0.5rem;
  background-color: #f7f7f7;
  border-left: 0rem solid #f7f7f7;
  font-size: 0.9em;
  font-style: normal;
  max-height: 100px;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 1px;
  border-radius: 4px;
}
.original-post-preview.loading {
  color: #888;
}
.nostr-ref {
  background-color: #f7f7f7;
  padding: 1px 2px;
  border-radius: 4px;
}
a.pubkey-ref {
  font-weight: bold;
  color: #555;
  text-decoration: none;
}
a.pubkey-ref:hover {
  text-decoration: underline;
}
time {
  color: #888;
}
</style>
</head>
<body>
  <h4>stargazer</h4><p>„Åì„ÅÆ„Éö„Éº„Ç∏„Åß„ÅØ„ÄÅÁâπÂÆö„ÅÆÂÖ¨ÈñãÈçµ„ÅåÂèó„ÅëÂèñ„Å£„Åü„É™„Ç¢„ÇØ„Ç∑„Éß„É≥Ôºà‚òÜÔºâ„ÇíË¶ã„Çã„Åì„Å®„Åå„Åß„Åç„Çã„Çà„ÄÇ</p><div><label for="target-hex-pubkey">ÂÖ¨ÈñãÈçµÔºànpubÔºâ</label><input id="target-hex-pubkey" type="text" placeholder="npub or hex or NIP-05"><button id="apply-pubkey-for-reactions">Ë¶ã„Çã</button></div>
  <hr/>
  <ul id="timeline"></ul>
  <button type="button" id="load-more" class="loading">„ÇÇ„Å£„Å®Ë¶ã„Çã</button>

  <script>
    // „Éò„É´„Éë„ÉºÈñ¢Êï∞Áæ§
    String.prototype.padStart = String.prototype.padStart ? String.prototype.padStart : function(targetLength, padString) {
      targetLength = Math.floor(targetLength) || 0;
      if (targetLength < this.length) return String(this);
    
      padString = padString ? String(padString) : " ";
    
      var pad = "";
      var len = targetLength - this.length;
      var i = 0;
      while (pad.length < len) {
        if (!padString[i]) {
          i = 0;
        }
        pad += padString[i];
        i++;
      }
      return pad + String(this).slice(0);
    };
    
    function getLanguage() {
      return (window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage).substring(0, 2);
    }
    
    function formatTimestamp(date) {
      return String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ":" + String(date.getSeconds()).padStart(2, "0");
    }
    
    function findTagWithValue(tags, name, value, extraPred) {
      for (var i = 0; i < tags.length; i++) {
        var tag = tags[i];
        if (tag[0] === name && tag[1] === value && (extraPred ? extraPred(tag) : true)) {
          return tag;
        }
      }
      return undefined;
    }
    
    function baseEventView() {
      var li = document.createElement("li");
      li.classList.add("event");
      return li;
    }
    
    function externalLink(url, text) {
      var a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noreferrer";
      a.textContent = text;
      return a;
    }
    
    function timestampView(unixtime) {
      var ts = new Date(unixtime * 1000);
      var timeElem = document.createElement("time");
      timeElem.setAttribute("datetime", ts.toISOString());
      timeElem.textContent = "[" + formatTimestamp(ts) + "]";
      return timeElem;
    }
    
    // === „Éó„É≠„Éï„Ç£„Éº„É´„Ç≠„É£„ÉÉ„Ç∑„É•„Å®pubkeyView„ÅÆÂ§âÊõ¥ ===
    const profileCache = {};
    const pubkeyElements = {};
    
    function getDisplayName(pubkey) {
      if (profileCache[pubkey] && profileCache[pubkey].name) {
        return profileCache[pubkey].name;
      }
      return pubkey.substring(0, 8);
    }
    
    function updatePubkeyView(pubkey) {
      const displayName = getDisplayName(pubkey);
      if (pubkeyElements[pubkey]) {
        pubkeyElements[pubkey].forEach(elem => {
          elem.textContent = displayName;
        });
      }
    }
    
    function pubkeyView(pubkey) {
      var npub = window.NostrTools.nip19.npubEncode(pubkey);
      var displayName = getDisplayName(pubkey);
      var a = externalLink("https://njump.me/" + npub, displayName);
      a.classList.add("pubkey-ref");
    
      if (!pubkeyElements[pubkey]) {
        pubkeyElements[pubkey] = [];
      }
      pubkeyElements[pubkey].push(a);
    
      return a;
    }
    
    function metadataView(nostrEv) {
      var view = document.createElement("span");
      view.appendChild(timestampView(nostrEv.created_at));
      view.appendChild(document.createTextNode(" "));
      view.appendChild(pubkeyView(nostrEv.pubkey));
      view.appendChild(document.createTextNode(" > "));
      return view;
    }
    
    function customEmojiElems(shortcode, nostrEv) {
      return [document.createTextNode(shortcode)];
    }
    
    // === „Ç§„Éô„É≥„Éà„Ç≠„É£„ÉÉ„Ç∑„É•„Å®ÂÖÉ„ÅÆÊäïÁ®øË°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ ===
    const eventCache = {};
    const eventsToFetch = new Set();
    let eventFetchTimeout = null;
    
    // ÂÖÉ„ÅÆÊäïÁ®øÂÜÖÂÆπ„ÇíÂèñÂæó„Åó„ÄÅË°®Á§∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function fetchAndDisplayOriginalPost(reactedEventId) {
      if (eventCache[reactedEventId]) {
        updateOriginalPostView(reactedEventId);
        return;
      }
    
      if (!eventsToFetch.has(reactedEventId)) {
        eventsToFetch.add(reactedEventId);
        scheduleEventFetch();
      }
    }
    
    // ÂèñÂæó„Åó„ÅüÂÖÉ„ÅÆÊäïÁ®ø„ÇíDOM„Å´ÂèçÊò†„Åô„ÇãÈñ¢Êï∞
    function updateOriginalPostView(reactedEventId) {
      const elementsToUpdate = document.querySelectorAll(`.original-post-preview[data-event-id="${reactedEventId}"]`);
      elementsToUpdate.forEach(elem => {
        const originalEvent = eventCache[reactedEventId];
        if (originalEvent) {
          elem.textContent = originalEvent.content.substring(0, 150) + (originalEvent.content.length > 150 ? '...' : '');
          elem.classList.remove('loading');
          elem.classList.remove('nostr-ref');
        }
      });
    }
    
    // „Ç§„Éô„É≥„Éà„Çí„Åæ„Å®„ÇÅ„Å¶„É™„ÇØ„Ç®„Çπ„Éà„Åô„Çã„Çπ„Ç±„Ç∏„É•„Éº„É© (reactionWS„Çí‰ΩøÁî®)
    function scheduleEventFetch() {
      if (eventFetchTimeout) {
        clearTimeout(eventFetchTimeout);
      }
      eventFetchTimeout = setTimeout(() => {
        if (eventsToFetch.size > 0 && reactionWS && reactionWS.readyState === WebSocket.OPEN) {
          const eventIds = Array.from(eventsToFetch);
          const subId = "FETCH_ORIGINAL_EVENTS_" + Date.now();
          reactionWS.send(JSON.stringify(["REQ", subId, {
            ids: eventIds,
            kinds: [1, 6],
            limit: eventIds.length
          }]));
        }
        eventFetchTimeout = null;
      }, 100);
    }
    
    // Kind:7 „Ç§„Éô„É≥„Éà„ÅÆË°®Á§∫Âá¶ÁêÜ
    function reactionEventView(nostrEv) {
      var view = baseEventView();
      view.id = nostrEv.id;
      view.classList.add("event-reaction");
    
      view.appendChild(metadataView(nostrEv));
    
      var reactionContent = nostrEv.content;
      if (reactionContent === "+") {
        reactionContent = "‚òÜ";
      } else if (reactionContent === "") {
        reactionContent = "üëç";
      } else if (reactionContent === undefined) {
        reactionContent = "üëç";
      }
    
      var contentSpan = document.createElement("span");
      contentSpan.textContent = " " + reactionContent + " ";
      view.appendChild(contentSpan);
    
      var reactedEventId;
      for (var i = 0; i < nostrEv.tags.length; i++) {
        var tag = nostrEv.tags[i];
        if (tag[0] === "e" && typeof tag[1] === "string") {
          reactedEventId = tag[1];
          break;
        }
      }
    
      if (reactedEventId) {
        const nevent = window.NostrTools.nip19.neventEncode({
          id: reactedEventId,
          relays: ["wss://relay.nostr.band"]
        });
        const link = externalLink(`https://njump.me/${nevent}`, `ÂÖÉ„ÅÆÊäïÁ®ø„ÇíË¶ã„Çã`);
        view.appendChild(document.createTextNode(" "));
        view.appendChild(link);
      }
    
      const originalPostContainer = document.createElement('div');
      originalPostContainer.classList.add('original-post-preview');
      originalPostContainer.id = `original-post-${nostrEv.id}`;
      originalPostContainer.setAttribute('data-event-id', reactedEventId);
      view.appendChild(document.createElement('br'));
      view.appendChild(originalPostContainer);
    
      if (reactedEventId) {
        originalPostContainer.textContent = `ÂÖÉ„ÅÆÊäïÁ®ø„ÇíÂèñÂæó‰∏≠... (nostr:${reactedEventId.substring(0, 8)}...)`;
        originalPostContainer.classList.add('loading');
        originalPostContainer.classList.add('nostr-ref');
        fetchAndDisplayOriginalPost(reactedEventId);
      } else {
        originalPostContainer.textContent = "ÂÖÉ„ÅÆÊäïÁ®ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
        originalPostContainer.classList.add('nostr-ref');
      }
      return view;
    }
    
    // ==== „É°„Ç§„É≥„ÅÆ„É≠„Ç∏„ÉÉ„ÇØÈÉ®ÂàÜ ====
    var timeline = document.getElementById("timeline");
    if (timeline === null) {
      throw new Error("no #timeline");
    }
    
    var targetHexPubkeyInput = document.getElementById("target-hex-pubkey");
    var applyPubkeyForReactionsButton = document.getElementById("apply-pubkey-for-reactions");
    
    // „É™„É¨„ÉºURL„ÇíÂõ∫ÂÆö
    const RELAY_URL = "wss://relay.nostr.band";
    
    var reactionWS;
    
    var oldestCreatedAt = Number.MAX_VALUE;
    var currentTargetPubkeyForReactions = undefined;
    
    var REACTION_SUB_ID = "motherfucking-reaction-sub";
    var PROFILE_SUB_ID_REACTIONS = "motherfucking-profile-sub-reactions";
    var MORE_REACTIONS_SUB_ID = "motherfucking-more-reactions-sub";
    
    const pubkeysToFetchProfile = new Set();
    let profileFetchTimeout = null;
    
    function clearTimeline() {
      while (timeline.firstChild) {
        timeline.removeChild(timeline.firstChild);
      }
      oldestCreatedAt = Number.MAX_VALUE;
    }
    
    function onEvent(nostrEv) {
      if (nostrEv.kind === 0) {
        try {
          const metadata = JSON.parse(nostrEv.content);
          profileCache[nostrEv.pubkey] = {
            name: metadata.name || nostrEv.pubkey.substring(0, 8),
            picture: metadata.picture,
            about: metadata.about
          };
          updatePubkeyView(nostrEv.pubkey);
          pubkeysToFetchProfile.delete(nostrEv.pubkey);
        } catch (e) {
          console.error("Failed to parse kind 0 content:", e);
        }
        return;
      }
    
      if (nostrEv.kind === 1 || nostrEv.kind === 6) {
        eventCache[nostrEv.id] = nostrEv;
        eventsToFetch.delete(nostrEv.id);
        updateOriginalPostView(nostrEv.id);
        return;
      }
    
      if (nostrEv.kind === 7) {
        if (document.getElementById(nostrEv.id)) {
          return;
        }
        const newReactionView = reactionEventView(nostrEv);
        timeline.appendChild(newReactionView);
        oldestCreatedAt = Math.min(oldestCreatedAt, nostrEv.created_at);
    
        if (!profileCache[nostrEv.pubkey] && !pubkeysToFetchProfile.has(nostrEv.pubkey)) {
          pubkeysToFetchProfile.add(nostrEv.pubkey);
          scheduleProfileFetch();
        }
      }
    }
    
    function scheduleProfileFetch() {
      if (profileFetchTimeout) {
        clearTimeout(profileFetchTimeout);
      }
      profileFetchTimeout = setTimeout(() => {
        if (pubkeysToFetchProfile.size > 0 && reactionWS && reactionWS.readyState === WebSocket.OPEN) {
          const pubkeys = Array.from(pubkeysToFetchProfile);
          const subId = "PROFILE_SUB_ID_REACTIONS_" + Date.now();
          reactionWS.send(JSON.stringify(["REQ", subId, {
            kinds: [0],
            authors: pubkeys,
            limit: pubkeys.length
          }]));
        }
        profileFetchTimeout = null;
      }, 100);
    }
    
    function subscribeToReactionRelay() {
      if (reactionWS) {
        reactionWS.removeEventListener("close", onReactionWSClose);
        reactionWS.close();
      }
      clearTimeline();
    
      try {
        reactionWS = new WebSocket(RELAY_URL);
      } catch (err) {
        console.error("Failed to connect to relay:", err);
        alert("Failed to connect to relay: " + RELAY_URL);
        return;
      }
    
      reactionWS.addEventListener("open", function() {
        console.log("Connected to relay:", RELAY_URL);
        if (currentTargetPubkeyForReactions) {
          reactionWS.send(
            JSON.stringify(["REQ", REACTION_SUB_ID, {
              kinds: [7],
              "#p": [currentTargetPubkeyForReactions],
              limit: 50
            }])
          );
        } else {
          loadMoreButton.classList.remove("loading");
        }
      });
    
      reactionWS.addEventListener("message", function(ev) {
        try {
          var r2cMsg = JSON.parse(ev.data);
          switch (r2cMsg[0]) {
            case "EVENT":
              var nostrEv = r2cMsg[2];
              if (!window.NostrTools.verifyEvent(nostrEv)) {
                console.error("nostr event with invalid signature:", nostrEv);
                return;
              }
              onEvent(nostrEv);
              break;
    
            case "EOSE":
              if (r2cMsg[1] === REACTION_SUB_ID || r2cMsg[1] === MORE_REACTIONS_SUB_ID) {
                loadMoreButton.classList.remove("loading");
              }
              break;
    
            case "OK":
              break;
            case "NOTICE":
              console.warn("Relay Notice:", r2cMsg[1]);
              break;
            default:
              console.log(r2cMsg);
              break;
          }
        } catch (err) {
          console.error(err);
        }
      });
    
      reactionWS.addEventListener("close", onReactionWSClose);
    }
    
    function onReactionWSClose() {
      console.log("Relay connection closed. Attempting to reconnect...");
      setTimeout(subscribeToReactionRelay, 5000);
    }

    // NIP-05Ê§úË®ºÈñ¢Êï∞„ÇíËøΩÂä†
    async function fetchPubkeyFromNip05(nip05) {
      const [user, domain] = nip05.split('@');
      if (!user || !domain) {
        throw new Error("Invalid NIP-05 address format.");
      }
    
      const url = `https://${domain}/.well-known/nostr.json?name=${user}`;
    
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch NIP-05 data: ${response.statusText}`);
        }
    
        const data = await response.json();
        const pubkey = data.names[user];
        if (!pubkey) {
          throw new Error(`User "${user}" not found in NIP-05 data.`);
        }
        return pubkey;
      } catch (e) {
        console.error("NIP-05 verification failed:", e);
        throw e;
      }
    }
    
    // ==== „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ====
    applyPubkeyForReactionsButton.addEventListener("click", async function() {
      var inputVal = targetHexPubkeyInput.value.trim();
      var hexPubkey;
    
      if (inputVal.startsWith("npub1")) {
        try {
          const { type, data } = window.NostrTools.nip19.decode(inputVal);
          if (type === "npub") {
            hexPubkey = data;
          } else {
            throw new Error("Invalid npub key.");
          }
        } catch (e) {
          console.error("Failed to decode npub:", e);
          alert("ÊúâÂäπ„Å™npubÂÖ¨ÈñãÈçµ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
          currentTargetPubkeyForReactions = undefined;
          clearTimeline();
          return;
        }
      } else if (inputVal.includes("@")) {
        try {
          hexPubkey = await fetchPubkeyFromNip05(inputVal);
        } catch (e) {
          alert("ÊúâÂäπ„Å™NIP-05„Ç¢„Éâ„É¨„Çπ„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
          currentTargetPubkeyForReactions = undefined;
          clearTimeline();
          return;
        }
      } else if (inputVal.length === 64 && /^[0-9a-fA-F]+$/.test(inputVal)) {
        hexPubkey = inputVal;
      } else {
        alert("ÊúâÂäπ„Å™hex„ÄÅnpub„ÄÅ„Åæ„Åü„ÅØNIP-05ÂÖ¨ÈñãÈçµ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        currentTargetPubkeyForReactions = undefined;
        clearTimeline();
        return;
      }
    
      currentTargetPubkeyForReactions = hexPubkey;
      console.log("Subscribing reactions for pubkey:", currentTargetPubkeyForReactions);
      subscribeToReactionRelay();
    });
    
    var loadMoreButton = document.getElementById("load-more");
    
    function fetchMoreReactions() {
      if (!reactionWS || reactionWS.readyState !== WebSocket.OPEN || !currentTargetPubkeyForReactions) {
        console.warn("Relay not connected or no target pubkey set.");
        return;
      }
      loadMoreButton.classList.add("loading");
    
      const filter = {
        kinds: [7],
        limit: 50,
        until: oldestCreatedAt - 1,
        "#p": [currentTargetPubkeyForReactions]
      };
      reactionWS.send(JSON.stringify(["REQ", MORE_REACTIONS_SUB_ID, filter]));
    }
    loadMoreButton.addEventListener("click", fetchMoreReactions);
    
    // ÂàùÊúüÂá¶ÁêÜ
    document.addEventListener("DOMContentLoaded", function() {
      // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Ëá™Âãï„Åß„É™„É¨„Éº„Å´Êé•Á∂ö
      subscribeToReactionRelay();
    });
  </script>
</body>
</html>
