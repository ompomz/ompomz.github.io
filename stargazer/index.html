<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>stargazer</title><script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{padding:8px;line-height:1.4;font-weight:normal}ul#timeline{padding-left:0;margin:0}li.event{list-style:none;word-break:break-all;border-bottom:1px solid #eee;padding:4px 0;font-weight:normal}li.event.event-reaction{background-color:#F0F8FF;font-style:italic}a.pubkey-ref{color:#B3B3B3;text-decoration:none}a.pubkey-ref:hover{text-decoration:underline}.original-post-preview{margin-top:0.5rem;background-color:#F5F5DC;border-left:1px solid #ccc;font-size:0.9em;font-style:normal;max-height:100px;overflow:hidden;text-overflow:ellipsis}</style></head><body><h4>Nostr kind:7 viewer.</h4><p>View reactions for a specific pubkey.</p><div><label for="target-hex-pubkey">pubkey:</label><input id="target-hex-pubkey" type="text" placeholder="hex"><button id="apply-pubkey-for-reactions">View</button></div><hr><ul id="timeline"></ul><button type="button" id="load-more" class="loading">More reactions please</button><script>String.prototype.padStart=String.prototype.padStart?String.prototype.padStart:function(a,b){a=Math.floor(a)||0;if(a<this.length)return String(this);b=b?String(b):" ";for(var c="",d=a-this.length,e=0;c.length<d;){if(!b[e])e=0;c+=b[e];e++}return c+String(this).slice(0)};function getLanguage(){return(window.navigator.language||window.navigator.browserLanguage||window.navigator.userLanguage).substring(0,2)}function formatTimestamp(a){return String(a.getHours()).padStart(2,"0")+":"+String(a.getMinutes()).padStart(2,"0")+":"+String(a.getSeconds()).padStart(2,"0")}function findTagWithValue(a,b,c,d){for(var e=0;e<a.length;e++){var f=a[e];if(f[0]===b&&f[1]===c&&(d?d(f):!0))return f}return undefined}function baseEventView(){var a=document.createElement("li");return a.classList.add("event"),a}function externalLink(a,b){var c=document.createElement("a");return c.href=a,c.target="_blank",c.rel="noreferrer",c.textContent=b,c}function timestampView(a){var b=new Date(1E3*a),c=document.createElement("time");return c.setAttribute("datetime",b.toISOString()),c.textContent="["+formatTimestamp(b)+"]",c}const profileCache={},pubkeyElements={};function getDisplayName(a){return profileCache[a]&&profileCache[a].name?profileCache[a].name:a.substring(0,8)}function updatePubkeyView(a){const b=getDisplayName(a);pubkeyElements[a]&&pubkeyElements[a].forEach(a=>{a.textContent=b})}function pubkeyView(a){var b=window.NostrTools.nip19.npubEncode(a),c=getDisplayName(a),d=externalLink("https://njump.me/"+b,c);return d.classList.add("pubkey-ref"),pubkeyElements[a]||(pubkeyElements[a]=[]),pubkeyElements[a].push(d),d}function metadataView(a){var b=document.createElement("span");return b.appendChild(timestampView(a.created_at)),b.appendChild(document.createTextNode(" ")),b.appendChild(pubkeyView(a.pubkey)),b.appendChild(document.createTextNode(" > ")),b}function customEmojiElems(a,b){return[document.createTextNode(a)]}const eventCache={},eventsToFetch=new Set;let eventFetchTimeout=null;function fetchAndDisplayOriginalPost(a){eventCache[a]?updateOriginalPostView(a):eventsToFetch.has(a)||!function(){eventsToFetch.add(a),scheduleEventFetch()}()}function updateOriginalPostView(a){const b=document.querySelectorAll(`.original-post-preview[data-event-id="${a}"]`);b.forEach(b=>{const c=eventCache[a];c&&(b.textContent=c.content.substring(0,150)+(c.content.length>150?"...":""),b.classList.remove("loading"))})}function scheduleEventFetch(){eventFetchTimeout&&clearTimeout(eventFetchTimeout),eventFetchTimeout=setTimeout(()=>{eventsToFetch.size>0&&reactionWS&&reactionWS.readyState===WebSocket.OPEN&&(reactionWS.send(JSON.stringify(["REQ","FETCH_ORIGINAL_EVENTS_"+Date.now(),{ids:Array.from(eventsToFetch),kinds:[1,6],limit:eventsToFetch.length}])),eventFetchTimeout=null)},100)}function reactionEventView(a){var b=baseEventView();b.id=a.id,b.classList.add("event-reaction"),b.appendChild(metadataView(a));var c=a.content;c==="+??"&&(c="‚ô°"),c===""&&(c="üëç"),void 0===c&&(c="üëç");var d=document.createElement("span");d.textContent=" "+c+" ",b.appendChild(d);var e;for(var f=0;f<a.tags.length;f++){var g=a.tags[f];if("e"===g[0]&&"string"==typeof g[1]){e=g[1];break}}if(e){const f=window.NostrTools.nip19.neventEncode({id:e,relays:["wss://relay.nostr.band"]}),g=externalLink(`https://njump.me/${f}`,"ÂÖÉ„ÅÆÊäïÁ®ø„ÇíË¶ã„Çã");b.appendChild(document.createTextNode(" ")),b.appendChild(g)}const h=document.createElement("div");return h.classList.add("original-post-preview"),h.id=`original-post-${a.id}`,h.setAttribute("data-event-id",e),b.appendChild(document.createElement("br")),b.appendChild(h),e?(h.textContent=`ÂÖÉ„ÅÆÊäïÁ®ø„ÇíÂèñÂæó‰∏≠... (nostr:${e.substring(0,8)}...)`,h.classList.add("loading"),fetchAndDisplayOriginalPost(e)):h.textContent="ÂÖÉ„ÅÆÊäïÁ®ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ",b}var timeline=document.getElementById("timeline");if(null===timeline)throw new Error("no #timeline");var targetHexPubkeyInput=document.getElementById("target-hex-pubkey"),applyPubkeyForReactionsButton=document.getElementById("apply-pubkey-for-reactions"),RELAY_URL="wss://relay.nostr.band",reactionWS,oldestCreatedAt=Number.MAX_VALUE,currentTargetPubkeyForReactions=undefined,REACTION_SUB_ID="motherfucking-reaction-sub",PROFILE_SUB_ID_REACTIONS="motherfucking-profile-sub-reactions",MORE_REACTIONS_SUB_ID="motherfucking-more-reactions-sub",pubkeysToFetchProfile=new Set;let profileFetchTimeout=null;function clearTimeline(){for(;timeline.firstChild;)timeline.removeChild(timeline.firstChild);oldestCreatedAt=Number.MAX_VALUE}function onEvent(a){if(0===a.kind)try{const b=JSON.parse(a.content);profileCache[a.pubkey]={name:b.name||a.pubkey.substring(0,8),picture:b.picture,about:b.about},updatePubkeyView(a.pubkey),pubkeysToFetchProfile.delete(a.pubkey)}catch(a){console.error("Failed to parse kind 0 content:",a)}if(1===a.kind||6===a.kind)return eventCache[a.id]=a,eventsToFetch.delete(a.id),void updateOriginalPostView(a.id);if(7===a.kind&&!document.getElementById(a.id)){const b=reactionEventView(a);timeline.appendChild(b),oldestCreatedAt=Math.min(oldestCreatedAt,a.created_at),profileCache[a.pubkey]||pubkeysToFetchProfile.has(a.pubkey)||(pubkeysToFetchProfile.add(a.pubkey),scheduleProfileFetch())}}function scheduleProfileFetch(){profileFetchTimeout&&clearTimeout(profileFetchTimeout),profileFetchTimeout=setTimeout(()=>{pubkeysToFetchProfile.size>0&&reactionWS&&reactionWS.readyState===WebSocket.OPEN&&(reactionWS.send(JSON.stringify(["REQ","PROFILE_SUB_ID_REACTIONS_"+Date.now(),{kinds:[0],authors:Array.from(pubkeysToFetchProfile),limit:pubkeysToFetchProfile.length}])),profileFetchTimeout=null)},100)}function subscribeToReactionRelay(){reactionWS&&(reactionWS.removeEventListener("close",onReactionWSClose),reactionWS.close()),clearTimeline();try{reactionWS=new WebSocket(RELAY_URL)}catch(a){return console.error("Failed to connect to relay:",a),void alert("Failed to connect to relay: "+RELAY_URL)}reactionWS.addEventListener("open",function(){console.log("Connected to relay:",RELAY_URL),currentTargetPubkeyForReactions?reactionWS.send(JSON.stringify(["REQ",REACTION_SUB_ID,{kinds:[7],"#p":[currentTargetPubkeyForReactions],limit:50}])):loadMoreButton.classList.remove("loading")}),reactionWS.addEventListener("message",function(a){try{var b=JSON.parse(a.data);switch(b[0]){case"EVENT":var c=b[2];window.NostrTools.verifyEvent(c)?onEvent(c):console.error("nostr event with invalid signature:",c);break;case"EOSE":(b[1]===REACTION_SUB_ID||b[1]===MORE_REACTIONS_SUB_ID)&&loadMoreButton.classList.remove("loading");break;case"OK":break;case"NOTICE":console.warn("Relay Notice:",b[1]);break;default:console.log(b)}}catch(a){console.error(a)}}),reactionWS.addEventListener("close",onReactionWSClose)}function onReactionWSClose(){console.log("Relay connection closed. Attempting to reconnect..."),setTimeout(subscribeToReactionRelay,5E3)}applyPubkeyForReactionsButton.addEventListener("click",function(){var a=targetHexPubkeyInput.value.trim();a.length===64&&/^[0-9a-fA-F]+$/.test(a)?(currentTargetPubkeyForReactions=a,console.log("Subscribing reactions for pubkey:",currentTargetPubkeyForReactions),subscribeToReactionRelay()):(alert("ÊúâÂäπ„Å™hexÂÖ¨ÈñãÈçµ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"),currentTargetPubkeyForReactions=undefined,clearTimeline())});var loadMoreButton=document.getElementById("load-more");function fetchMoreReactions(){if(!reactionWS||reactionWS.readyState!==WebSocket.OPEN||!currentTargetPubkeyForReactions)return void console.warn("Relay not connected or no target pubkey set.");loadMoreButton.classList.add("loading");const a={kinds:[7],limit:50,until:oldestCreatedAt-1,"#p":[currentTargetPubkeyForReactions]};reactionWS.send(JSON.stringify(["REQ",MORE_REACTIONS_SUB_ID,a]))}loadMoreButton.addEventListener("click",fetchMoreReactions),document.addEventListener("DOMContentLoaded",function(){subscribeToReactionRelay()})</script></body></html>
