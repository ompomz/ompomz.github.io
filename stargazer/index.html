<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>stargazer</title>
Â  <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
  <script>
Â  Â  String.prototype.padStart = String.prototype.padStart ? String.prototype.padStart : function(targetLength, padString) {
Â  Â  Â  targetLength = Math.floor(targetLength) || 0;
Â  Â  Â  if(targetLength < this.length) return String(this);

Â  Â  Â  padString = padString ? String(padString) : " ";

Â  Â  Â  var pad = "";
Â  Â  Â  var len = targetLength - this.length;
Â  Â  Â  var i = 0;
Â  Â  Â  while(pad.length < len) {
Â  Â  Â  Â  if(!padString[i]) {
Â  Â  Â  Â  Â  i = 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  pad += padString[i];
Â  Â  Â  Â  i++;
Â  Â  Â  }
Â  Â  Â  return pad + String(this).slice(0);
Â  Â  };

Â  Â  function getLanguage() {
Â  Â  Â  return (window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage).substring(0, 2);
Â  Â  }
Â  </script>
Â  <style>
/* ãƒªã‚»ãƒƒãƒˆCSS */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬çš„ãªè¨­å®š */
body {
    padding: 8px;
    line-height: 1.4;
    font-weight: normal;
}

/* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
ul#timeline {
    padding-left: 0;
    margin: 0;
}

li.event {
    list-style: none;
    word-break: break-all;
    border-bottom: 1px solid #eee;
    padding: 4px 0;
    font-weight: normal;
}

/* ä¸­é»’ã‚’æ¶ˆã™ãŸã‚ã®è¿½åŠ è¨­å®š */
#timeline li {
    list-style: none !important;
}

/* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½™ç™½ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
h4, p, div {
    margin-bottom: 0.5rem;
}

div > * {
    margin-right: 8px;
}

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®é«˜ã•ã¨ä½ç½®ã‚’æƒãˆã‚‹ */
label, input, button {
    vertical-align: middle;
}

/* æŠ•ç¨¿ã®ç¨®é¡ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
li.event.event-reaction {
    background-color: hsl(268, 100%, 98%);
    font-style: italic;
}

/* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
button#load-more.loading {
    visibility: hidden;
}

/* Nostrãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.nostr-ref {
    background-color: hsl(268, 100%, 98%);
}

/* å…¬é–‹éµã®å‚ç…§ï¼ˆåå‰ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
a.pubkey-ref {
    color: #B3B3B3;
    text-decoration: none;
}

a.pubkey-ref:hover {
    text-decoration: underline;
}

/* ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
a {
    color: #0000ff;
}

/* å…ƒã®æŠ•ç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.original-post-preview {
    margin-top: 0.5rem;
    background-color: hsl(268, 100%, 98%);
    border-left: 1px solid #ccc;
    font-size: 0.9em;
    font-style: normal;
    max-height: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
}
.original-post-preview.loading {
    color: #888;
}
</style>
</head>
<body>
Â  <h4>Nostr kind:7 viewer.</h4>
  <p>View reactions for a specific pubkey.</p>
Â  <div><label for="target-hex-pubkey">pubkey:</label><input id="target-hex-pubkey" type="text" placeholder="hex"><button id="apply-pubkey-for-reactions">View</button></div>
Â  <hr />
Â  <ul id="timeline"></ul>
Â  <button type="button" id="load-more" class="loading">More reactions please</button>

Â  <script>
Â  Â  // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
Â  Â  String.prototype.padStart = String.prototype.padStart ? String.prototype.padStart : function(targetLength, padString) {
Â  Â  Â  targetLength = Math.floor(targetLength) || 0;
Â  Â  Â  if (targetLength < this.length) return String(this);
Â  Â  
Â  Â  Â  padString = padString ? String(padString) : " ";
Â  Â  
Â  Â  Â  var pad = "";
Â  Â  Â  var len = targetLength - this.length;
Â  Â  Â  var i = 0;
Â  Â  Â  while (pad.length < len) {
Â  Â  Â  Â  if (!padString[i]) {
Â  Â  Â  Â  Â  i = 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  pad += padString[i];
Â  Â  Â  Â  i++;
Â  Â  Â  }
Â  Â  Â  return pad + String(this).slice(0);
Â  Â  };
Â  Â  
Â  Â  function getLanguage() {
Â  Â  Â  return (window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage).substring(0, 2);
Â  Â  }
Â  Â  
Â  Â  function formatTimestamp(date) {
Â  Â  Â  return String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") + ":" + String(date.getSeconds()).padStart(2, "0");
Â  Â  }
Â  Â  
Â  Â  function findTagWithValue(tags, name, value, extraPred) {
Â  Â  Â  for (var i = 0; i < tags.length; i++) {
Â  Â  Â  Â  var tag = tags[i];
Â  Â  Â  Â  if (tag[0] === name && tag[1] === value && (extraPred ? extraPred(tag) : true)) {
Â  Â  Â  Â  Â  return tag;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return undefined;
Â  Â  }
Â  Â  
Â  Â  function baseEventView() {
Â  Â  Â  var li = document.createElement("li");
Â  Â  Â  li.classList.add("event");
Â  Â  Â  return li;
Â  Â  }
Â  Â  
Â  Â  function externalLink(url, text) {
Â  Â  Â  var a = document.createElement("a");
Â  Â  Â  a.href = url;
Â  Â  Â  a.target = "_blank";
Â  Â  Â  a.rel = "noreferrer";
Â  Â  Â  a.textContent = text;
Â  Â  Â  return a;
Â  Â  }
Â  Â  
Â  Â  function timestampView(unixtime) {
Â  Â  Â  var ts = new Date(unixtime * 1000);
Â  Â  Â  var timeElem = document.createElement("time");
Â  Â  Â  timeElem.setAttribute("datetime", ts.toISOString());
Â  Â  Â  timeElem.textContent = "[" + formatTimestamp(ts) + "]";
Â  Â  Â  return timeElem;
Â  Â  }
Â  Â  
Â  Â  // === ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨pubkeyViewã®å¤‰æ›´ ===
Â  Â  const profileCache = {};
Â  Â  const pubkeyElements = {};
Â  Â  
Â  Â  function getDisplayName(pubkey) {
Â  Â  Â  if (profileCache[pubkey] && profileCache[pubkey].name) {
Â  Â  Â  Â  return profileCache[pubkey].name;
Â  Â  Â  }
Â  Â  Â  return pubkey.substring(0, 8);
Â  Â  }
Â  Â  
Â  Â  function updatePubkeyView(pubkey) {
Â  Â  Â  const displayName = getDisplayName(pubkey);
Â  Â  Â  if (pubkeyElements[pubkey]) {
Â  Â  Â  Â  pubkeyElements[pubkey].forEach(elem => {
Â  Â  Â  Â  Â  elem.textContent = displayName;
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  function pubkeyView(pubkey) {
Â  Â  Â  var npub = window.NostrTools.nip19.npubEncode(pubkey);
Â  Â  Â  var displayName = getDisplayName(pubkey);
Â  Â  Â  var a = externalLink("https://njump.me/" + npub, displayName);
Â  Â  Â  a.classList.add("pubkey-ref");
Â  Â  
Â  Â  Â  if (!pubkeyElements[pubkey]) {
Â  Â  Â  Â  pubkeyElements[pubkey] = [];
Â  Â  Â  }
Â  Â  Â  pubkeyElements[pubkey].push(a);
Â  Â  
Â  Â  Â  return a;
Â  Â  }
Â  Â  
Â  Â  function metadataView(nostrEv) {
Â  Â  Â  var view = document.createElement("span");
Â  Â  Â  view.appendChild(timestampView(nostrEv.created_at));
Â  Â  Â  view.appendChild(document.createTextNode(" "));
Â  Â  Â  view.appendChild(pubkeyView(nostrEv.pubkey));
Â  Â  Â  view.appendChild(document.createTextNode(" > "));
Â  Â  Â  return view;
Â  Â  }
Â  Â  
Â  Â  function customEmojiElems(shortcode, nostrEv) {
Â  Â  Â  return [document.createTextNode(shortcode)];
Â  Â  }
Â  Â  
Â  Â  // === ã‚¤ãƒ™ãƒ³ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨å…ƒã®æŠ•ç¨¿è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ===
Â  Â  const eventCache = {};
Â  Â  const eventsToFetch = new Set();
Â  Â  let eventFetchTimeout = null;
Â  Â  
Â  Â  // å…ƒã®æŠ•ç¨¿å†…å®¹ã‚’å–å¾—ã—ã€è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
Â  Â  function fetchAndDisplayOriginalPost(reactedEventId) {
Â  Â  Â  if (eventCache[reactedEventId]) {
Â  Â  Â  Â  updateOriginalPostView(reactedEventId);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  
Â  Â  Â  if (!eventsToFetch.has(reactedEventId)) {
Â  Â  Â  Â  eventsToFetch.add(reactedEventId);
Â  Â  Â  Â  scheduleEventFetch();
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // å–å¾—ã—ãŸå…ƒã®æŠ•ç¨¿ã‚’DOMã«åæ˜ ã™ã‚‹é–¢æ•°
Â  Â  function updateOriginalPostView(reactedEventId) {
Â  Â  Â  const elementsToUpdate = document.querySelectorAll(`.original-post-preview[data-event-id="${reactedEventId}"]`);
Â  Â  Â  elementsToUpdate.forEach(elem => {
Â  Â  Â  Â  const originalEvent = eventCache[reactedEventId];
Â  Â  Â  Â  if (originalEvent) {
Â  Â  Â  Â  Â  elem.textContent = originalEvent.content.substring(0, 150) + (originalEvent.content.length > 150 ? '...' : '');
Â  Â  Â  Â  Â  elem.classList.remove('loading');
Â  Â  Â  Â  Â  elem.classList.remove('nostr-ref');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  Â  
Â  Â  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã¾ã¨ã‚ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ© (reactionWSã‚’ä½¿ç”¨)
Â  Â  function scheduleEventFetch() {
Â  Â  Â  if (eventFetchTimeout) {
Â  Â  Â  Â  clearTimeout(eventFetchTimeout);
Â  Â  Â  }
Â  Â  Â  eventFetchTimeout = setTimeout(() => {
Â  Â  Â  Â  if (eventsToFetch.size > 0 && reactionWS && reactionWS.readyState === WebSocket.OPEN) {
Â  Â  Â  Â  Â  const eventIds = Array.from(eventsToFetch);
Â  Â  Â  Â  Â  const subId = "FETCH_ORIGINAL_EVENTS_" + Date.now();
Â  Â  Â  Â  Â  reactionWS.send(JSON.stringify(["REQ", subId, {
Â  Â  Â  Â  Â  Â  ids: eventIds,
Â  Â  Â  Â  Â  Â  kinds: [1, 6],
Â  Â  Â  Â  Â  Â  limit: eventIds.length
Â  Â  Â  Â  Â  }]));
Â  Â  Â  Â  }
Â  Â  Â  Â  eventFetchTimeout = null;
Â  Â  Â  }, 100);
Â  Â  }
Â  Â  
Â  Â  // Kind:7 ã‚¤ãƒ™ãƒ³ãƒˆã®è¡¨ç¤ºå‡¦ç†
Â  Â  function reactionEventView(nostrEv) {
Â  Â  Â  var view = baseEventView();
Â  Â  Â  view.id = nostrEv.id;
Â  Â  Â  view.classList.add("event-reaction");
Â  Â  
Â  Â  Â  view.appendChild(metadataView(nostrEv));
Â  Â  
Â  Â  Â  var reactionContent = nostrEv.content;
Â  Â  Â  if (reactionContent === "+") {
Â  Â  Â  Â  reactionContent = "â™¡";
Â  Â  Â  } else if (reactionContent === "") {
Â  Â  Â  Â  reactionContent = "ğŸ‘";
Â  Â  Â  } else if (reactionContent === undefined) {
Â  Â  Â  Â  reactionContent = "ğŸ‘";
Â  Â  Â  }
Â  Â  
Â  Â  Â  var contentSpan = document.createElement("span");
Â  Â  Â  contentSpan.textContent = " " + reactionContent + " ";
Â  Â  Â  view.appendChild(contentSpan);
Â  Â  
Â  Â  Â  var reactedEventId;
Â  Â  Â  for (var i = 0; i < nostrEv.tags.length; i++) {
Â  Â  Â  Â  var tag = nostrEv.tags[i];
Â  Â  Â  Â  if (tag[0] === "e" && typeof tag[1] === "string") {
Â  Â  Â  Â  Â  reactedEventId = tag[1];
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  
Â  Â  Â  if (reactedEventId) {
Â  Â  Â  Â  const nevent = window.NostrTools.nip19.neventEncode({
Â  Â  Â  Â  Â  id: reactedEventId,
Â  Â  Â  Â  Â  relays: ["wss://relay.nostr.band"]
Â  Â  Â  Â  });
Â  Â  Â  Â  const link = externalLink(`https://njump.me/${nevent}`, `å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹`);
Â  Â  Â  Â  view.appendChild(document.createTextNode(" "));
Â  Â  Â  Â  view.appendChild(link);
Â  Â  Â  }
Â  Â  
Â  Â  Â  const originalPostContainer = document.createElement('div');
Â  Â  Â  originalPostContainer.classList.add('original-post-preview');
Â  Â  Â  originalPostContainer.id = `original-post-${nostrEv.id}`;
Â  Â  Â  originalPostContainer.setAttribute('data-event-id', reactedEventId);
Â  Â  Â  view.appendChild(document.createElement('br'));
Â  Â  Â  view.appendChild(originalPostContainer);
Â  Â  
Â  Â  Â  if (reactedEventId) {
Â  Â  Â  Â  originalPostContainer.textContent = `å…ƒã®æŠ•ç¨¿ã‚’å–å¾—ä¸­... (nostr:${reactedEventId.substring(0, 8)}...)`;
Â  Â  Â  Â  originalPostContainer.classList.add('loading');
Â  Â  Â  Â  originalPostContainer.classList.add('nostr-ref');
Â  Â  Â  Â  fetchAndDisplayOriginalPost(reactedEventId);
Â  Â  Â  } else {
Â  Â  Â  Â  originalPostContainer.textContent = "å…ƒã®æŠ•ç¨¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
Â  Â  Â  Â  originalPostContainer.classList.add('nostr-ref');
Â  Â  Â  }
Â  Â  Â  return view;
Â  Â  }
Â  Â  
Â  Â  // ==== ãƒ¡ã‚¤ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯éƒ¨åˆ† ====
Â  Â  var timeline = document.getElementById("timeline");
Â  Â  if (timeline === null) {
Â  Â  Â  throw new Error("no #timeline");
Â  Â  }
Â  Â  
Â  Â  var targetHexPubkeyInput = document.getElementById("target-hex-pubkey");
Â  Â  var applyPubkeyForReactionsButton = document.getElementById("apply-pubkey-for-reactions");
Â  Â  
Â  Â  // ãƒªãƒ¬ãƒ¼URLã‚’å›ºå®š
Â  Â  const RELAY_URL = "wss://relay.nostr.band";
Â  Â  
Â  Â  var reactionWS;
Â  Â  
Â  Â  var oldestCreatedAt = Number.MAX_VALUE;
Â  Â  var currentTargetPubkeyForReactions = undefined;
Â  Â  
Â  Â  var REACTION_SUB_ID = "motherfucking-reaction-sub";
Â  Â  var PROFILE_SUB_ID_REACTIONS = "motherfucking-profile-sub-reactions";
Â  Â  var MORE_REACTIONS_SUB_ID = "motherfucking-more-reactions-sub";
Â  Â  
Â  Â  const pubkeysToFetchProfile = new Set();
Â  Â  let profileFetchTimeout = null;
Â  Â  
Â  Â  function clearTimeline() {
Â  Â  Â  while (timeline.firstChild) {
Â  Â  Â  Â  timeline.removeChild(timeline.firstChild);
Â  Â  Â  }
Â  Â  Â  oldestCreatedAt = Number.MAX_VALUE;
Â  Â  }
Â  Â  
Â  Â  function onEvent(nostrEv) {
Â  Â  Â  if (nostrEv.kind === 0) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const metadata = JSON.parse(nostrEv.content);
Â  Â  Â  Â  Â  profileCache[nostrEv.pubkey] = {
Â  Â  Â  Â  Â  Â  name: metadata.name || nostrEv.pubkey.substring(0, 8),
Â  Â  Â  Â  Â  Â  picture: metadata.picture,
Â  Â  Â  Â  Â  Â  about: metadata.about
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  updatePubkeyView(nostrEv.pubkey);
Â  Â  Â  Â  Â  pubkeysToFetchProfile.delete(nostrEv.pubkey);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error("Failed to parse kind 0 content:", e);
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  
Â  Â  Â  if (nostrEv.kind === 1 || nostrEv.kind === 6) {
Â  Â  Â  Â  eventCache[nostrEv.id] = nostrEv;
Â  Â  Â  Â  eventsToFetch.delete(nostrEv.id);
Â  Â  Â  Â  updateOriginalPostView(nostrEv.id);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  
Â  Â  Â  if (nostrEv.kind === 7) {
Â  Â  Â  Â  if (document.getElementById(nostrEv.id)) {
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const newReactionView = reactionEventView(nostrEv);
Â  Â  Â  Â  timeline.appendChild(newReactionView);
Â  Â  Â  Â  oldestCreatedAt = Math.min(oldestCreatedAt, nostrEv.created_at);
Â  Â  
Â  Â  Â  Â  if (!profileCache[nostrEv.pubkey] && !pubkeysToFetchProfile.has(nostrEv.pubkey)) {
Â  Â  Â  Â  Â  pubkeysToFetchProfile.add(nostrEv.pubkey);
Â  Â  Â  Â  Â  scheduleProfileFetch();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  function scheduleProfileFetch() {
Â  Â  Â  if (profileFetchTimeout) {
Â  Â  Â  Â  clearTimeout(profileFetchTimeout);
Â  Â  Â  }
Â  Â  Â  profileFetchTimeout = setTimeout(() => {
Â  Â  Â  Â  if (pubkeysToFetchProfile.size > 0 && reactionWS && reactionWS.readyState === WebSocket.OPEN) {
Â  Â  Â  Â  Â  const pubkeys = Array.from(pubkeysToFetchProfile);
Â  Â  Â  Â  Â  const subId = "PROFILE_SUB_ID_REACTIONS_" + Date.now();
Â  Â  Â  Â  Â  reactionWS.send(JSON.stringify(["REQ", subId, {
Â  Â  Â  Â  Â  Â  kinds: [0],
Â  Â  Â  Â  Â  Â  authors: pubkeys,
Â  Â  Â  Â  Â  Â  limit: pubkeys.length
Â  Â  Â  Â  Â  }]));
Â  Â  Â  Â  }
Â  Â  Â  Â  profileFetchTimeout = null;
Â  Â  Â  }, 100);
Â  Â  }
Â  Â  
Â  Â  function subscribeToReactionRelay() {
Â  Â  Â  if (reactionWS) {
Â  Â  Â  Â  reactionWS.removeEventListener("close", onReactionWSClose);
Â  Â  Â  Â  reactionWS.close();
Â  Â  Â  }
Â  Â  Â  clearTimeline();
Â  Â  
Â  Â  Â  try {
Â  Â  Â  Â  reactionWS = new WebSocket(RELAY_URL);
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  console.error("Failed to connect to relay:", err);
Â  Â  Â  Â  alert("Failed to connect to relay: " + RELAY_URL);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  
Â  Â  Â  reactionWS.addEventListener("open", function() {
Â  Â  Â  Â  console.log("Connected to relay:", RELAY_URL);
Â  Â  Â  Â  if (currentTargetPubkeyForReactions) {
Â  Â  Â  Â  Â  reactionWS.send(
Â  Â  Â  Â  Â  Â  JSON.stringify(["REQ", REACTION_SUB_ID, {
Â  Â  Â  Â  Â  Â  Â  kinds: [7],
Â  Â  Â  Â  Â  Â  Â  "#p": [currentTargetPubkeyForReactions],
Â  Â  Â  Â  Â  Â  Â  limit: 50
Â  Â  Â  Â  Â  Â  }])
Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  loadMoreButton.classList.remove("loading");
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  
Â  Â  Â  reactionWS.addEventListener("message", function(ev) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  var r2cMsg = JSON.parse(ev.data);
Â  Â  Â  Â  Â  switch (r2cMsg[0]) {
Â  Â  Â  Â  Â  Â  case "EVENT":
Â  Â  Â  Â  Â  Â  Â  var nostrEv = r2cMsg[2];
Â  Â  Â  Â  Â  Â  Â  if (!window.NostrTools.verifyEvent(nostrEv)) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("nostr event with invalid signature:", nostrEv);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  onEvent(nostrEv);
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  
Â  Â  Â  Â  Â  Â  case "EOSE":
Â  Â  Â  Â  Â  Â  Â  if (r2cMsg[1] === REACTION_SUB_ID || r2cMsg[1] === MORE_REACTIONS_SUB_ID) {
Â  Â  Â  Â  Â  Â  Â  Â  loadMoreButton.classList.remove("loading");
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  
Â  Â  Â  Â  Â  Â  case "OK":
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  case "NOTICE":
Â  Â  Â  Â  Â  Â  Â  console.warn("Relay Notice:", r2cMsg[1]);
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  console.log(r2cMsg);
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  
Â  Â  Â  reactionWS.addEventListener("close", onReactionWSClose);
Â  Â  }
Â  Â  
Â  Â  function onReactionWSClose() {
Â  Â  Â  console.log("Relay connection closed. Attempting to reconnect...");
Â  Â  Â  setTimeout(subscribeToReactionRelay, 5000);
Â  Â  }
Â  Â  
Â  Â  // ==== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ====
Â  Â  applyPubkeyForReactionsButton.addEventListener("click", function() {
Â  Â  Â  var hexPubkey = targetHexPubkeyInput.value.trim();
Â  Â  Â  if (hexPubkey.length === 64 && /^[0-9a-fA-F]+$/.test(hexPubkey)) {
Â  Â  Â  Â  currentTargetPubkeyForReactions = hexPubkey;
Â  Â  Â  Â  console.log("Subscribing reactions for pubkey:", currentTargetPubkeyForReactions);
Â  Â  Â  Â  subscribeToReactionRelay();
Â  Â  Â  } else {
Â  Â  Â  Â  alert("æœ‰åŠ¹ãªhexå…¬é–‹éµã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
Â  Â  Â  Â  currentTargetPubkeyForReactions = undefined;
Â  Â  Â  Â  clearTimeline();
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  var loadMoreButton = document.getElementById("load-more");
Â  Â  
Â  Â  function fetchMoreReactions() {
Â  Â  Â  if (!reactionWS || reactionWS.readyState !== WebSocket.OPEN || !currentTargetPubkeyForReactions) {
Â  Â  Â  Â  console.warn("Relay not connected or no target pubkey set.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  loadMoreButton.classList.add("loading");
Â  Â  
Â  Â  Â  const filter = {
Â  Â  Â  Â  kinds: [7],
Â  Â  Â  Â  limit: 50,
Â  Â  Â  Â  until: oldestCreatedAt - 1,
Â  Â  Â  Â  "#p": [currentTargetPubkeyForReactions]
Â  Â  Â  };
Â  Â  Â  reactionWS.send(JSON.stringify(["REQ", MORE_REACTIONS_SUB_ID, filter]));
Â  Â  }
Â  Â  loadMoreButton.addEventListener("click", fetchMoreReactions);
Â  Â  
Â  Â  // åˆæœŸå‡¦ç†
Â  Â  document.addEventListener("DOMContentLoaded", function() {
Â  Â  Â  // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•ã§ãƒªãƒ¬ãƒ¼ã«æ¥ç¶š
Â  Â  Â  subscribeToReactionRelay();
Â  Â  });
Â  </script>
</body>
</html>
